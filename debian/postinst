#!/bin/sh

# postinst script for korean-ime-fixer
# Configures Fcitx5 for Korean input with focus on GNOME desktop

set -e

case "$1" in
    configure)
        echo "Configuring Korean IME Fixer for GNOME desktop..."

        # Create systemd environment.d configuration (primary for GNOME Wayland)
        mkdir -p /etc/environment.d
        cat > /etc/environment.d/60-korean-ime-fixer.conf <<'EOF'
# Korean IME Fixer - systemd environment configuration
# This file configures Korean input method for GNOME Wayland sessions
GTK_IM_MODULE=fcitx
QT_IM_MODULE=fcitx
XMODIFIERS=@im=fcitx
SDL_IM_MODULE=fcitx
GLFW_IM_MODULE=ibus
EOF
        chmod 644 /etc/environment.d/60-korean-ime-fixer.conf

        # Create profile.d script for X11 sessions and fallback
        cat > /etc/profile.d/korean-ime-fixer.sh <<'EOF'
#!/bin/sh
# Korean IME Fixer - Profile script for X11 sessions
# Fallback configuration for non-systemd environments
if [ "$XDG_SESSION_TYPE" != "wayland" ] || [ "$XDG_CURRENT_DESKTOP" != "GNOME" ]; then
    export GTK_IM_MODULE=fcitx
    export QT_IM_MODULE=fcitx
    export XMODIFIERS=@im=fcitx
    export SDL_IM_MODULE=fcitx
fi
EOF
        chmod 755 /etc/profile.d/korean-ime-fixer.sh

        # Create KDE Plasma workspace environment script
        mkdir -p /etc/xdg/plasma-workspace/env
        cat > /etc/xdg/plasma-workspace/env/60-korean-ime-fixer.sh <<'EOF'
#!/bin/sh
# Korean IME Fixer - KDE Plasma environment script
export GTK_IM_MODULE=fcitx
export QT_IM_MODULE=fcitx
export XMODIFIERS=@im=fcitx
export SDL_IM_MODULE=fcitx
EOF
        chmod 755 /etc/xdg/plasma-workspace/env/60-korean-ime-fixer.sh

        # Configure system input method via im-config
        if command -v im-config >/dev/null 2>&1; then
            echo "Configuring system input method to fcitx5..."
            im-config -n fcitx5
        fi

        # Create user autostart entry for fcitx5
        mkdir -p /etc/skel/.config/autostart
        cat > /etc/skel/.config/autostart/korean-ime-fixer.desktop <<'EOF'
[Desktop Entry]
Type=Application
Name=Korean IME Fixer Fcitx5
Name[ko]=한국어 입력기 자동 시작
Exec=fcitx5 -d --replace
Icon=fcitx
StartupNotify=false
Hidden=false
X-GNOME-Autostart-enabled=true
X-KDE-autostart-after=panel
EOF
        chmod 644 /etc/skel/.config/autostart/korean-ime-fixer.desktop

        # Apply autostart file to existing users
        for user_home in /home/*; do
            if [ -d "$user_home" ] && [ -w "$user_home" ]; then
                user_name=$(basename "$user_home")
                if id "$user_name" >/dev/null 2>&1; then
                    mkdir -p "$user_home/.config/autostart"
                    cp /etc/skel/.config/autostart/korean-ime-fixer.desktop "$user_home/.config/autostart/"
                    chown "$user_name:$user_name" "$user_home/.config/autostart/korean-ime-fixer.desktop" 2>/dev/null || true
                fi
            fi
        done

        # Force reload systemd user environment
        if command -v systemctl >/dev/null 2>&1; then
            systemctl --global daemon-reload 2>/dev/null || true
        fi

        echo "Korean IME Fixer configuration completed successfully!"
        echo ""
        echo "IMPORTANT: Please reboot your system for all changes to take effect."
        echo ""
        echo "After reboot:"
        echo "1. Korean input should work automatically in most applications"
        echo "2. Use Ctrl+Space or configure your preferred hotkey in fcitx5-configtool"
        echo "3. For Chrome/Chromium browsers, ensure Wayland flags are enabled"
        echo ""
        echo "For troubleshooting, run: fcitx5-diagnose"
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
        exit 0
    ;;

    *)
        echo "postinst called with unknown argument \`$1\'" >&2
        exit 1
    ;;
esac

#DEBHELPER#

exit 0
